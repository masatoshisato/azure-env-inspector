# infra/ フォルダー詳細説明書

作成日: 2026年1月21日

## フォルダーの目的

`infra/` は、Azureインフラストラクチャをコードで定義するフォルダーです。Bicep言語を使用してInfrastructure as Code (IaC) を実装し、Azure上のリソース（リソースグループ、PostgreSQL、ネットワークなど）を宣言的に定義・デプロイします。

---

## ファイル一覧と目的

### 1. `main.bicep`
**目的**: メインのインフラストラクチャ定義ファイル

**スコープ**: `subscription`（サブスクリプションレベル）

**内容の詳細説明**:

```bicep
// デプロイ対象をサブスクリプションレベルに設定
targetScope = 'subscription'

// ========================================
// パラメータ定義
// ========================================

// 環境名（dev, staging, prodなど）
@minLength(1)
@maxLength(64)
@description('Name of the environment which is used to generate a short unique hash for resource names.')
param environmentName string

// デプロイ先のAzureリージョン
@minLength(1)
@description('Primary location for all resources.')
param location string

// PostgreSQL管理者ログイン名
@description('PostgreSQL administrator login name.')
param postgresAdminLogin string = 'pgadmin'

// PostgreSQL管理者パスワード（セキュア）
@secure()
@description('PostgreSQL administrator password.')
param postgresAdminPassword string

// PostgreSQLデータベース名
@description('PostgreSQL database name.')
param postgresDatabaseName string = 'appdb'

// Entra ID認証の有効/無効
@description('Enable Entra ID authentication.')
@allowed([
  'Enabled'
  'Disabled'
])
param entraIdAuthEnabled string = 'Enabled'

// Entra ID管理者のオブジェクトID
@description('Entra ID administrator object ID.')
param entraIdAdminObjectId string = ''

// Entra ID管理者のプリンシパル名
@description('Entra ID administrator principal name.')
param entraIdAdminPrincipalName string = ''

// ========================================
// 変数定義
// ========================================

// すべてのリソースに適用するタグ
var tags = {
  'azd-env-name': environmentName
}

// リソース名に使用する一意のトークン生成
// サブスクリプションID、環境名、リージョンからハッシュ生成
var resourceToken = toLower(uniqueString(subscription().id, environmentName, location))

// リソースグループ名
var resourceGroupName = 'rg-${environmentName}'

// ========================================
// リソース定義
// ========================================

// リソースグループの作成
resource rg 'Microsoft.Resources/resourceGroups@2021-04-01' = {
  name: resourceGroupName
  location: location
  tags: tags
}
```

**技術詳細**:

1. **`@secure()` デコレーター**
   - パスワードなどの機密情報をマスク
   - ログやデプロイ履歴に平文で表示されない

2. **`@allowed()` デコレーター**
   - 許可された値のみを受け付ける
   - デプロイ時の入力ミスを防止

3. **`uniqueString()` 関数**
   - 入力値から一意のハッシュを生成（13文字）
   - 同じ入力には常に同じ出力（決定的）
   - リソース名の重複を防止

4. **`targetScope = 'subscription'`**
   - サブスクリプションレベルでのデプロイ
   - リソースグループを作成できる
   - 複数のリソースグループにまたがる構成も可能

**現状の制限**:
- PostgreSQLモジュール（`postgresql.bicep`）の呼び出しがまだ実装されていない
- 今後、以下を追加予定:
  ```bicep
  module postgres 'postgresql.bicep' = {
    scope: rg
    name: 'postgresql-deployment'
    params: {
      location: location
      serverName: 'psql-${resourceToken}'
      administratorLogin: postgresAdminLogin
      administratorLoginPassword: postgresAdminPassword
      databaseName: postgresDatabaseName
      // ... その他のパラメータ
    }
  }
  ```

---

### 2. `main.parameters.bicepparam`
**目的**: `main.bicep`に渡すパラメータファイル

**内容の詳細説明**:

```bicep-params
// 使用するBicepテンプレートの指定
using './main.bicep'

// ========================================
// 環境変数からパラメータを読み込み
// ========================================

// 環境名（デフォルト: 'dev'）
param environmentName = readEnvironmentVariable('AZURE_ENV_NAME', 'dev')

// デプロイ先リージョン（デフォルト: 'japaneast'）
param location = readEnvironmentVariable('AZURE_LOCATION', 'japaneast')

// PostgreSQL管理者ログイン名（デフォルト: 'pgadmin'）
param postgresAdminLogin = readEnvironmentVariable('POSTGRES_ADMIN_LOGIN', 'pgadmin')

// PostgreSQL管理者パスワード（必須、デフォルトなし）
param postgresAdminPassword = readEnvironmentVariable('POSTGRES_ADMIN_PASSWORD')

// PostgreSQLデータベース名（デフォルト: 'appdb'）
param postgresDatabaseName = readEnvironmentVariable('POSTGRES_DATABASE_NAME', 'appdb')

// Entra ID認証の有効化（デフォルト: 'Enabled'）
param entraIdAuthEnabled = readEnvironmentVariable('ENTRA_ID_AUTH_ENABLED', 'Enabled')

// Entra ID管理者オブジェクトID（デフォルト: 空文字）
param entraIdAdminObjectId = readEnvironmentVariable('ENTRA_ID_ADMIN_OBJECT_ID', '')

// Entra ID管理者プリンシパル名（デフォルト: 空文字）
param entraIdAdminPrincipalName = readEnvironmentVariable('ENTRA_ID_ADMIN_PRINCIPAL_NAME', '')
```

**技術詳細**:

1. **`readEnvironmentVariable()` 関数**
   - 第1引数: 環境変数名
   - 第2引数: デフォルト値（環境変数が未設定の場合）
   - `.env`ファイルまたはシステム環境変数から読み込む

2. **環境変数の読み込み順序**
   ```
   1. システム環境変数
   2. .envファイル（ルートディレクトリ）
   3. デフォルト値
   ```

3. **セキュリティ上の注意**
   - `POSTGRES_ADMIN_PASSWORD`はデフォルト値なし（必須）
   - デプロイ前に必ず設定する必要がある
   - `.env`ファイルは`.gitignore`に追加すること

**使用方法**:
```bash
# .envファイルを作成
cp .env.sample .env
# .envファイルを編集して値を設定

# デプロイ時に自動的に読み込まれる
az deployment sub create \
  --location japaneast \
  --template-file infra/main.bicep \
  --parameters infra/main.parameters.bicepparam
```

---

### 3. `postgresql.bicep`
**目的**: Azure Database for PostgreSQL Flexible Serverのモジュール定義

**スコープ**: `resourceGroup`（リソースグループレベル）

**内容の詳細説明**:

```bicep
// ========================================
// パラメータ定義
// ========================================

// デプロイ先のリージョン
@description('Location for all resources.')
param location string

// タグ（親から渡される）
@description('Tags to apply to resources.')
param tags object = {}

// PostgreSQLサーバー名（3〜63文字）
@minLength(3)
@maxLength(63)
@description('Name of the PostgreSQL flexible server.')
param serverName string

// 管理者ログイン名
@description('PostgreSQL administrator login name.')
param administratorLogin string

// 管理者パスワード（セキュア）
@secure()
@description('PostgreSQL administrator password.')
param administratorLoginPassword string

// データベース名
@description('PostgreSQL database name.')
param databaseName string

// PostgreSQLバージョン
@description('PostgreSQL version.')
@allowed([
  '18'   // 最新（2026年時点）
  '17'
  '16'   // デフォルト、推奨バージョン
  '15'
  '14'
  '13'
])
param postgresVersion string = '16'

// コンピュートティア
@description('Compute tier of the server.')
@allowed([
  'Burstable'         // バースト可能（開発/テスト向け、低コスト）
  'GeneralPurpose'    // 汎用（本番向け）
  'MemoryOptimized'   // メモリ最適化（高負荷向け）
])
param skuTier string = 'Burstable'

// SKU名（インスタンスサイズ）
@description('Compute size name.')
param skuName string = 'Standard_B1ms'
// Burstable: Standard_B1ms, Standard_B2s
// GeneralPurpose: Standard_D2s_v3, Standard_D4s_v3
// MemoryOptimized: Standard_E2s_v3, Standard_E4s_v3

// ストレージサイズ（GB）
@description('Storage size in GB.')
@minValue(32)      // 最小32GB
@maxValue(16384)   // 最大16TB
param storageSizeGB int = 32

// バックアップ保持期間（日）
@description('Backup retention days.')
@minValue(7)       // 最小7日
@maxValue(35)      // 最大35日
param backupRetentionDays int = 7

// Geo冗長バックアップ
@description('Enable geo-redundant backup.')
@allowed([
  'Enabled'   // 有効: 別リージョンにバックアップ複製（高可用性）
  'Disabled'  // 無効: 同一リージョンのみ（コスト削減）
])
param geoRedundantBackup string = 'Disabled'

// 高可用性
@description('Enable high availability.')
@allowed([
  'Enabled'   // 有効: Zone-redundant HA（99.99% SLA）
  'Disabled'  // 無効: 単一ゾーン（99.9% SLA）
])
param highAvailability string = 'Disabled'

// 可用性ゾーン
@description('Availability zone for the server.')
param availabilityZone string = ''
// 例: '1', '2', '3'（空文字の場合はAzureが自動選択）

// Entra ID認証の有効化
@description('Enable Entra ID authentication.')
@allowed([
  'Enabled'   // 推奨: Azure AD認証（パスワードレス）
  'Disabled'
])
param entraIdAuthEnabled string = 'Enabled'

// Entra ID管理者オブジェクトID
@description('Entra ID administrator object ID (required when entraIdAuthEnabled is Enabled).')
param entraIdAdminObjectId string = ''

// Entra ID管理者プリンシパル名
@description('Entra ID administrator principal name (required when entraIdAuthEnabled is Enabled).')
param entraIdAdminPrincipalName string = ''

// Entra IDテナントID
@description('Entra ID tenant ID.')
param entraIdTenantId string = subscription().tenantId

// ========================================
// リソース定義
// ========================================

// PostgreSQL Flexible Server
resource postgresServer 'Microsoft.DBforPostgreSQL/flexibleServers@2025-08-01' = {
  name: serverName
  location: location
  tags: tags
  sku: {
    name: skuName
    tier: skuTier
  }
  properties: {
    version: postgresVersion
    administratorLogin: administratorLogin
    administratorLoginPassword: administratorLoginPassword
    availabilityZone: !empty(availabilityZone) ? availabilityZone : null
    storage: {
      storageSizeGB: storageSizeGB
      autoGrow: 'Enabled'  // ストレージ自動拡張
    }
    backup: {
      backupRetentionDays: backupRetentionDays
      geoRedundantBackup: geoRedundantBackup
    }
    highAvailability: {
      mode: highAvailability == 'Enabled' ? 'ZoneRedundant' : 'Disabled'
    }
    // ... 続きがあるが、現在のファイルは159行
  }
}
```

**技術詳細**:

1. **SKUティアの選択基準**

   | ティア | 用途 | コスト | SLA |
   |--------|------|--------|-----|
   | Burstable | 開発/テスト | 最低 | 99.9% |
   | GeneralPurpose | 本番（標準） | 中 | 99.9% |
   | MemoryOptimized | 高負荷 | 高 | 99.9% |

2. **ストレージ自動拡張**
   - `autoGrow: 'Enabled'` で自動的にストレージ拡張
   - 容量不足による停止を防止
   - 拡張は一方向（縮小不可）

3. **バックアップ戦略**
   - 自動バックアップ: 毎日実行
   - ポイントインタイムリストア: 保持期間内の任意の時点に復元可能
   - Geo冗長: 別リージョンにコピー（災害対策）

4. **高可用性（HA）**
   - `ZoneRedundant`: 複数の可用性ゾーンに配置
   - 自動フェイルオーバー
   - RPO: 0（データ損失なし）
   - RTO: 数分

5. **Entra ID認証（推奨）**
   - パスワードレス認証
   - Managed Identityと統合
   - Azure RBACで細かいアクセス制御

---

### 4. `rg.bicep`
**目的**: リソースグループ作成のための独立したテンプレート

**スコープ**: `subscription`（サブスクリプションレベル）

**内容の詳細説明**:

```bicep
// メタデータ: テンプレートの説明
metadata name = 'Resource Group for Azure Env Inspector'

// デプロイスコープの設定
targetScope = 'subscription'

// ========================================
// パラメータ定義
// ========================================

// システム名（フル）
param systemName string

// システム名（短縮形）
param systemShort string

// 担当部門名
param inChargeDeptName string

// デプロイ先リージョン
param location string

// リージョン短縮形
param locationShort string

// デプロイ実行者
param author string

// バージョン番号
param version string

// リソースグループ名
param rgName string

// デプロイ日時（UTC、自動取得）
param deploymentDate string = utcNow('yyyy-MM-dd')

// デプロイメント名（自動取得）
param deploymentName string = deployment().name

// タグの定義
param tags object = {
  SystemName: systemName                  // システム名
  DeptName: inChargeDeptName              // 担当部門
  DeploymentDate: deploymentDate          // デプロイ日時
  DeploymentBy: author                    // デプロイ実行者
  DeploymentVersion: version              // バージョン
  DeploymentName: deploymentName          // デプロイメント名
}

// ========================================
// リソース定義
// ========================================

// リソースグループの作成
resource rgAei 'Microsoft.Resources/resourceGroups@2025-04-01' = {
  name: rgName
  location: location
  tags: tags
}
```

**技術詳細**:

1. **`utcNow()` 関数**
   - デプロイ実行時のUTC日時を取得
   - フォーマット: `yyyy-MM-dd`（例: 2026-01-21）
   - 監査ログとして使用

2. **`deployment()` 関数**
   - 現在のデプロイメントに関する情報を取得
   - `deployment().name`: デプロイメント名
   - `deployment().properties`: デプロイメントプロパティ

3. **タグの用途**
   - **コスト管理**: 部門別コスト配分
   - **監査**: いつ、誰がデプロイしたか追跡
   - **運用**: システムの識別、バージョン管理

4. **リソースグループの役割**
   - リソースの論理的なコンテナ
   - ライフサイクル管理: 一括削除可能
   - RBAC: グループ単位でアクセス制御
   - ポリシー: グループ単位でポリシー適用

---

### 5. `rg.bicepparam`
**目的**: `rg.bicep`に渡すパラメータファイル

**内容の詳細説明**:

```bicep-params
// 使用するBicepテンプレートの指定
using './rg.bicep'

// ========================================
// システム情報
// ========================================

// システム名（フル）
param systemName = 'AzureEnvInspector'

// システム名（短縮形）
param systemShort = 'aei'

// 担当部門名
param inChargeDeptName = 'default-dept'

// ========================================
// リージョン情報
// ========================================

// デプロイ先リージョン
param location = 'japaneast'

// リージョン短縮形
param locationShort = 'je'
// japaneast -> je
// eastus -> eus
// westeurope -> weu

// ========================================
// デプロイ情報
// ========================================

// デプロイ実行者
param author = 'masatoshi.sato'

// バージョン番号
param version = '1.0.0'

// ========================================
// リソースグループ名の生成
// ========================================

// 命名規則: rg-{SystemName}-{LocationShort}
// 例: rg-AzureEnvInspector-je
param rgName = 'rg-${systemName}-${locationShort}'
```

**命名規則の説明**:

```
rg-AzureEnvInspector-je
│  │                  │
│  │                  └─ リージョン短縮形
│  └─────────────────── システム名
└────────────────────── リソースタイプ（Resource Group）
```

**命名規則のベストプラクティス**:
- **プレフィックス**: リソースタイプを識別（rg-, vm-, st-など）
- **システム名**: 用途を明確に
- **サフィックス**: 環境やリージョンを識別
- **ケバブケース**: ハイフン区切り（Azure推奨）
- **長さ制限**: リソースタイプごとに最大文字数が異なる

---

## Bicepファイルのデバッグ方法

### 方法1: Bicep CLI での検証

#### 1. Bicepファイルのビルド（構文チェック）

```bash
# 単一ファイルの検証
az bicep build --file infra/main.bicep

# 成功時の出力
# (何も表示されない = エラーなし)

# エラーがある場合
# Error BCP073: The property "invalidProperty" is read-only.
```

**検証内容**:
- 構文エラー
- 型の不一致
- 未定義のプロパティ
- 循環参照

#### 2. Lintによるベストプラクティスチェック

```bash
# Lintの実行
az bicep lint --file infra/main.bicep

# 警告例
# Warning no-unused-params: Parameter "unusedParam" is declared but never used.
```

**Lintルール**:
- 未使用のパラメータ
- 未使用の変数
- セキュリティのベストプラクティス
- 命名規則

#### 3. デコンパイル（ARM → Bicep変換）

```bash
# ARMテンプレートからBicepに変換
az bicep decompile --file template.json
```

---

### 方法2: What-If分析（推奨）

**目的**: デプロイ前に変更内容をプレビュー

```bash
# サブスクリプションレベルでのWhat-If
az deployment sub what-if \
  --name "infra-whatif-$(date +%Y%m%d-%H%M%S)" \
  --location japaneast \
  --template-file infra/main.bicep \
  --parameters infra/main.parameters.bicepparam
```

**出力例**:
```
Resource changes: 3 to create, 0 to modify, 0 to delete.

+ Microsoft.Resources/resourceGroups/rg-dev
  name: "rg-dev"
  location: "japaneast"
  tags: {
    "azd-env-name": "dev"
  }

+ Microsoft.DBforPostgreSQL/flexibleServers/psql-abc123
  name: "psql-abc123"
  location: "japaneast"
  sku: {
    name: "Standard_B1ms"
    tier: "Burstable"
  }
```

**確認項目**:
- ✅ 作成されるリソース
- ✅ 変更されるリソース
- ✅ 削除されるリソース
- ✅ リソース名とプロパティ
- ⚠️ 意図しない変更がないか

---

### 方法3: VS Code Bicep拡張機能

#### 前提条件
- VS Code Bicep拡張機能がインストール済み（devcontainer.jsonで自動インストール）

#### 機能

1. **リアルタイム検証**
   - 入力中にエラーを表示
   - 赤い波線でエラー箇所を強調

2. **インテリセンス**
   - リソースタイプの自動補完
   - プロパティの候補表示
   - ドキュメントのホバー表示

3. **リソースビジュアライザー**
   - Bicepファイルを開く
   - 右上の「Bicep Visualizer」アイコンをクリック
   - リソースの依存関係を図で表示

4. **定義へジャンプ**
   - `Ctrl + クリック`（Mac: `Cmd + クリック`）
   - モジュールやパラメータの定義元にジャンプ

---

### 方法4: デプロイ検証モード

**目的**: 実際にデプロイせずに検証のみ実行

```bash
# 検証モードでデプロイ
az deployment sub validate \
  --location japaneast \
  --template-file infra/main.bicep \
  --parameters infra/main.parameters.bicepparam
```

**検証内容**:
- テンプレートの構文
- パラメータの妥当性
- リソースプロバイダーの登録状態
- クォータチェック（容量確認）
- ロールベースのアクセス制御（RBAC）

**成功時の出力**:
```json
{
  "id": "/subscriptions/.../providers/Microsoft.Resources/deployments/...",
  "properties": {
    "provisioningState": "Succeeded",
    ...
  }
}
```

---

### トラブルシューティング

#### エラー: `InvalidTemplate`

**原因**: Bicepの構文エラー

**解決方法**:
```bash
# ビルドして詳細を確認
az bicep build --file infra/main.bicep
```

---

#### エラー: `ResourceNotFound`

**原因**: 参照しているリソースが存在しない

**解決方法**:
- リソース名が正しいか確認
- `existing`キーワードで既存リソースを参照
  ```bicep
  resource existingRg 'Microsoft.Resources/resourceGroups@2021-04-01' existing = {
    name: 'rg-dev'
  }
  ```

---

#### エラー: `QuotaExceeded`

**原因**: サブスクリプションのクォータ超過

**解決方法**:
```bash
# クォータを確認
az vm list-usage --location japaneast -o table

# クォータ引き上げリクエスト
# Azure Portal → サポート → 新しいサポートリクエスト
```

---

## Bicepファイルのデプロイ方法

### 前提条件

1. **Azure CLIのインストール**
   ```bash
   az version
   # 出力: "azure-cli": "2.81.0"
   ```

2. **Azureへのログイン**
   ```bash
   az login
   # ブラウザが開き、認証
   ```

3. **サブスクリプションの選択**
   ```bash
   # 利用可能なサブスクリプション一覧
   az account list -o table
   
   # サブスクリプションの設定
   az account set --subscription <subscription-id>
   ```

4. **環境変数の設定**
   ```bash
   # .env.sampleをコピー
   cp .env.sample .env
   
   # .envファイルを編集
   # POSTGRES_ADMIN_PASSWORDなどを設定
   ```

---

### デプロイ手順

#### ステップ1: 検証（What-If）

```bash
cd /workspaces/azure-env-inspector

# What-If分析
az deployment sub what-if \
  --name "infra-whatif-$(date +%Y%m%d-%H%M%S)" \
  --location japaneast \
  --template-file infra/main.bicep \
  --parameters infra/main.parameters.bicepparam
```

**確認ポイント**:
- 作成されるリソースの数
- リソース名が正しいか
- SKU/ティアが意図通りか
- 削除されるリソースがないか（既存環境の場合）

---

#### ステップ2: デプロイ実行

```bash
# デプロイ実行（タイムスタンプ付き）
az deployment sub create \
  --name "infra-deploy-$(date +%Y%m%d-%H%M%S)" \
  --location japaneast \
  --template-file infra/main.bicep \
  --parameters infra/main.parameters.bicepparam
```

**実行時の出力**:
```
⠸ Running ...

{
  "id": "/subscriptions/.../providers/Microsoft.Resources/deployments/infra-deploy-20260121-143000",
  "location": "japaneast",
  "name": "infra-deploy-20260121-143000",
  "properties": {
    "correlationId": "...",
    "duration": "PT2M34.5678S",
    "mode": "Incremental",
    "provisioningState": "Succeeded",
    "timestamp": "2026-01-21T14:32:34.567890+00:00"
  }
}
```

**デプロイ時間の目安**:
- リソースグループのみ: 数秒
- PostgreSQL Flexible Server: 5〜10分
- 高可用性（HA）有効時: 10〜15分

---

#### ステップ3: デプロイ結果の確認

```bash
# デプロイステータスの確認
az deployment sub show \
  --name "infra-deploy-20260121-143000"

# 出力（outputs）の確認
az deployment sub show \
  --name "infra-deploy-20260121-143000" \
  --query properties.outputs

# リソースグループ内のリソース一覧
az resource list \
  --resource-group rg-dev \
  --output table
```

**期待される出力**:
```
Name                          ResourceGroup    Location    Type
----------------------------  ---------------  ----------  ----------------------
rg-dev                        -                japaneast   Microsoft.Resources/resourceGroups
psql-abc123def456             rg-dev           japaneast   Microsoft.DBforPostgreSQL/flexibleServers
```

---

### デプロイオプション

#### 1. インクリメンタルモード（デフォルト）

```bash
az deployment sub create \
  --mode Incremental \
  --template-file infra/main.bicep \
  ...
```

**特徴**:
- テンプレートに定義されたリソースのみ作成/更新
- テンプレートに定義されていないリソースは保持
- **推奨**: 通常のデプロイに使用

---

#### 2. 完全モード（Complete）

```bash
az deployment sub create \
  --mode Complete \
  --template-file infra/main.bicep \
  ...
```

**特徴**:
- テンプレートに定義されたリソースのみ残す
- テンプレートに定義されていないリソースは削除
- **注意**: 意図しないリソース削除に注意

---

#### 3. パラメータの上書き

```bash
# パラメータファイルの値を上書き
az deployment sub create \
  --template-file infra/main.bicep \
  --parameters infra/main.parameters.bicepparam \
  --parameters environmentName=prod location=eastus
```

---

#### 4. 並列デプロイ

複数のリソースグループに同時デプロイ:

```bash
# リソースグループ1
az deployment sub create \
  --name "infra-dev" \
  --template-file infra/main.bicep \
  --parameters environmentName=dev &

# リソースグループ2
az deployment sub create \
  --name "infra-staging" \
  --template-file infra/main.bicep \
  --parameters environmentName=staging &

wait  # 両方の完了を待つ
```

---

### トラブルシューティング

#### エラー: `InvalidTemplateDeployment`

**原因**: パラメータ不足または型不一致

**解決方法**:
```bash
# .envファイルを確認
cat .env

# 必須パラメータ（POSTGRES_ADMIN_PASSWORD）が設定されているか確認
```

---

#### エラー: `ResourceDeploymentFailure`

**原因**: リソース作成中のエラー

**解決方法**:
```bash
# デプロイログの確認
az deployment sub show \
  --name "infra-deploy-20260121-143000" \
  --query properties.error

# Azure Portalでエラー詳細を確認
# Portal → デプロイ → 該当デプロイ → エラーメッセージ
```

---

#### デプロイが途中で停止

**原因**: ネットワークエラーまたはタイムアウト

**解決方法**:
```bash
# デプロイステータスを確認
az deployment sub show \
  --name "infra-deploy-20260121-143000" \
  --query properties.provisioningState

# 再デプロイ（インクリメンタルモードなら安全）
az deployment sub create \
  --name "infra-deploy-$(date +%Y%m%d-%H%M%S)" \
  --template-file infra/main.bicep \
  --parameters infra/main.parameters.bicepparam
```

---

## クリーンアップ（リソース削除）

### 方法1: リソースグループごと削除

```bash
# リソースグループを削除（すべてのリソースが削除される）
az group delete \
  --name rg-dev \
  --yes \
  --no-wait

# 削除状態の確認
az group show --name rg-dev
# エラー: ResourceGroupNotFound = 削除完了
```

---

### 方法2: 個別リソースの削除

```bash
# PostgreSQLサーバーのみ削除
az postgres flexible-server delete \
  --resource-group rg-dev \
  --name psql-abc123def456 \
  --yes
```

---

## まとめ

- **Bicepファイル**: インフラをコードで定義（IaC）
- **デバッグ**: `az bicep build`、What-If、VS Code拡張機能
- **デプロイ**: `az deployment sub create`でサブスクリプションレベル
- **検証**: What-Ifで事前確認が必須
- **クリーンアップ**: リソースグループごと削除が簡単
