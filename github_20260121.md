# .github/ フォルダー詳細説明書

作成日: 2026年1月21日

## フォルダーの目的

`.github/` は、GitHubリポジトリの設定とCI/CDパイプライン（GitHub Actions）を格納するフォルダーです。インフラストラクチャとアプリケーションの自動デプロイ、検証、テストを管理します。

---

## フォルダー構造

```
.github/
├── workflows/            # GitHub Actionsワークフロー定義
│   ├── infra-deploy.yml  # インフラデプロイ
│   └── app-deploy.yml    # アプリデプロイ
└── SECRETS_SETUP.md      # Secrets設定ガイド
```

---

## ファイル一覧と目的

### 1. `workflows/infra-deploy.yml`
**目的**: インフラストラクチャの自動デプロイワークフロー

**トリガー条件**:
- 現在: 手動トリガーのみ（`workflow_dispatch`）
- 将来: `infra/`配下のファイル変更時に自動実行可能

**内容の詳細説明**:

```yaml
name: Deploy Infrastructure

# ========================================
# トリガー設定
# ========================================
on:
  # 自動トリガー（Secrets設定後に有効化）
  # push:
  #   branches:
  #     - main                              # mainブランチへのプッシュ
  #   paths:
  #     - 'infra/**'                        # infra/配下の変更時のみ
  #     - '.github/workflows/infra-deploy.yml'  # ワークフロー自体の変更時も
  
  # 手動トリガー
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'  # デプロイ先環境
        required: true
        default: 'dev'
        type: choice
        options:
          - dev        # 開発環境
          - staging    # ステージング環境
          - prod       # 本番環境

# ========================================
# 環境変数
# ========================================
env:
  AZURE_LOCATION: japaneast    # デプロイ先リージョン

# ========================================
# ジョブ定義
# ========================================
jobs:
  # --- 検証ジョブ ---
  validate:
    name: Validate Bicep Templates
    runs-on: ubuntu-latest      # 実行環境: GitHub-hosted Ubuntu
    
    steps:
      # ステップ1: コードのチェックアウト
      - name: Checkout code
        uses: actions/checkout@v4  # GitHubアクション: リポジトリをクローン
      
      # ステップ2: Azureにログイン
      - name: Azure Login
        uses: azure/login@v2       # GitHubアクション: Azure認証
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}  # Secretsから認証情報取得
      
      # ステップ3: Bicep CLIのインストール
      - name: Install Bicep CLI
        run: az bicep install      # Azure CLIでBicepをインストール
      
      # ステップ4: Bicepファイルのビルド（構文チェック）
      - name: Bicep Build (Lint)
        run: |
          echo "Building Bicep templates to check for errors..."
          az bicep build --file infra/main.bicep
      
      # ステップ5: What-If分析（変更内容のプレビュー）
      - name: What-If Analysis
        run: |
          echo "Running what-if analysis to preview changes..."
          az deployment sub what-if \
            --name "infra-whatif-$(date +%Y%m%d-%H%M%S)" \
            --location ${{ env.AZURE_LOCATION }} \
            --template-file infra/main.bicep \
            --parameters infra/main.parameters.bicepparam
  
  # --- デプロイジョブ ---
  deploy:
    name: Deploy to Azure
    runs-on: ubuntu-latest
    needs: validate               # validateジョブの成功が前提
    # 本番環境への自動デプロイを防ぐ場合は、以下をコメント解除
    # environment: 
    #   name: production          # 環境名
    #   url: https://portal.azure.com  # Azure Portal URL
    
    steps:
      # ステップ1: コードのチェックアウト
      - name: Checkout code
        uses: actions/checkout@v4
      
      # ステップ2: Azureにログイン
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      
      # ステップ3: インフラストラクチャのデプロイ
      - name: Deploy Infrastructure
        id: deploy                # ステップIDを設定（後続ステップで参照可能）
        run: |
          DEPLOYMENT_NAME="infra-deploy-$(date +%Y%m%d-%H%M%S)"
          echo "deployment_name=$DEPLOYMENT_NAME" >> $GITHUB_OUTPUT  # 出力変数に設定
          
          az deployment sub create \
            --name "$DEPLOYMENT_NAME" \
            --location ${{ env.AZURE_LOCATION }} \
            --template-file infra/main.bicep \
            --parameters infra/main.parameters.bicepparam
      
      # ステップ4: デプロイ結果の取得
      - name: Get Deployment Outputs
        run: |
          echo "Deployment completed. Fetching outputs..."
          az deployment sub show \
            --name "${{ steps.deploy.outputs.deployment_name }}" \
            --query properties.outputs
      
      # ステップ5: デプロイサマリーの表示
      - name: Deployment Summary
        run: |
          echo "## Infrastructure Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ Deployment Name: ${{ steps.deploy.outputs.deployment_name }}" >> $GITHUB_STEP_SUMMARY
          echo "🌏 Location: ${{ env.AZURE_LOCATION }}" >> $GITHUB_STEP_SUMMARY
          echo "🔗 [View in Azure Portal](https://portal.azure.com/#blade/HubsExtension/DeploymentDetailsBlade/overview)" >> $GITHUB_STEP_SUMMARY
```

**技術詳細**:

1. **`needs: validate`**
   - ジョブの依存関係を定義
   - validateジョブが成功しないとdeployジョブは実行されない
   - デプロイ前の検証を強制

2. **`${{ secrets.AZURE_CREDENTIALS }}`**
   - GitHubリポジトリのSecretsから認証情報を取得
   - Secretsは暗号化されて保存
   - ログには`***`として表示（マスク）

3. **`$GITHUB_OUTPUT`**
   - ステップ間で値を受け渡す仕組み
   - `echo "key=value" >> $GITHUB_OUTPUT`で設定
   - `${{ steps.<step-id>.outputs.<key> }}`で参照

4. **`$GITHUB_STEP_SUMMARY`**
   - GitHub ActionsのサマリーページにMarkdownを出力
   - ジョブ実行後に確認しやすい形で情報を表示

**実行フロー**:
```
1. ソースコードのチェックアウト
2. Azureに認証
3. Bicepファイルの構文チェック
4. What-If分析（変更内容のプレビュー）
   ↓ 検証成功
5. インフラストラクチャのデプロイ実行
6. デプロイ結果の取得と表示
```

---

### 2. `workflows/app-deploy.yml`
**目的**: アプリケーションの自動デプロイワークフロー

**トリガー条件**:
- 現在: 手動トリガーのみ（`workflow_dispatch`）
- 将来: `apps/env-inspector/`配下のファイル変更時に自動実行可能

**内容の詳細説明**:

```yaml
name: Deploy Application

# ========================================
# トリガー設定
# ========================================
on:
  # 自動トリガー（Secrets設定後に有効化）
  # push:
  #   branches:
  #     - main
  #   paths:
  #     - 'apps/env-inspector/**'           # アプリコードの変更時のみ
  #     - '.github/workflows/app-deploy.yml'
  
  # 手動トリガー
  workflow_dispatch:
    inputs:
      app_name:
        description: 'Application to deploy'  # デプロイするアプリ
        required: true
        default: 'env-inspector'
        type: choice
        options:
          - env-inspector    # 現在は1つのみ、将来的に追加可能

# ========================================
# ジョブ定義
# ========================================
jobs:
  # --- ビルドジョブ ---
  build:
    name: Build Application
    runs-on: ubuntu-latest
    
    steps:
      # ステップ1: コードのチェックアウト
      - name: Checkout code
        uses: actions/checkout@v4
      
      # ステップ2: Node.jsのセットアップ
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'                # Node.js 20.x
          cache: 'npm'                      # npmキャッシュを有効化
          cache-dependency-path: 'apps/env-inspector/package-lock.json'
      
      # ステップ3: 依存パッケージのインストール
      - name: Install dependencies
        working-directory: apps/env-inspector  # 作業ディレクトリを指定
        run: npm ci                            # npm install の高速版（CI向け）
      
      # ステップ4: テストの実行
      - name: Run tests
        working-directory: apps/env-inspector
        run: npm test --if-present             # テストがあれば実行（なければスキップ）
      
      # ステップ5: アプリケーションのビルド
      - name: Build application
        working-directory: apps/env-inspector
        run: npm run build --if-present        # ビルドスクリプトがあれば実行
      
      # ステップ6: デプロイパッケージの作成
      - name: Create deployment package
        working-directory: apps/env-inspector
        run: |
          # アプリケーションファイルをZIPにパッケージ化
          # node_modulesと.gitファイルは除外
          zip -r ../env-inspector.zip . -x "node_modules/*" "*.git*"
      
      # ステップ7: アーティファクトのアップロード
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-package                   # アーティファクト名
          path: apps/env-inspector.zip        # アップロードするファイル
          retention-days: 1                   # 保持期間（1日）
  
  # --- デプロイジョブ ---
  deploy:
    name: Deploy to Azure
    runs-on: ubuntu-latest
    needs: build                              # buildジョブの成功が前提
    # 本番環境への自動デプロイを防ぐ場合は、以下をコメント解除
    # environment: 
    #   name: production
    
    steps:
      # ステップ1: アーティファクトのダウンロード
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: app-package                   # buildジョブでアップロードしたもの
      
      # ステップ2: Azureにログイン
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      
      # ステップ3: Azure Web Appへのデプロイ
      - name: Deploy to Azure Web App
        id: deploy-webapp
        run: |
          # Web Appが存在する場合のデプロイ
          # リソース名は環境変数またはSecretsで管理
          if [ -n "${{ secrets.WEBAPP_NAME }}" ]; then
            az webapp deployment source config-zip \
              --resource-group ${{ secrets.RESOURCE_GROUP_NAME }} \
              --name ${{ secrets.WEBAPP_NAME }} \
              --src env-inspector.zip
            
            WEBAPP_URL=$(az webapp show \
              --resource-group ${{ secrets.RESOURCE_GROUP_NAME }} \
              --name ${{ secrets.WEBAPP_NAME }} \
              --query defaultHostName -o tsv)
            echo "webapp_url=https://$WEBAPP_URL" >> $GITHUB_OUTPUT
          fi
      
      # ステップ4: Azure Functionsへのデプロイ
      - name: Deploy to Azure Functions
        id: deploy-functions
        run: |
          # Azure Functionsが存在する場合のデプロイ
          if [ -n "${{ secrets.FUNCTION_APP_NAME }}" ]; then
            az functionapp deployment source config-zip \
              --resource-group ${{ secrets.RESOURCE_GROUP_NAME }} \
              --name ${{ secrets.FUNCTION_APP_NAME }} \
              --src env-inspector.zip
            
            FUNC_URL=$(az functionapp show \
              --resource-group ${{ secrets.RESOURCE_GROUP_NAME }} \
              --name ${{ secrets.FUNCTION_APP_NAME }} \
              --query defaultHostName -o tsv)
            echo "function_url=https://$FUNC_URL" >> $GITHUB_OUTPUT
          fi
      
      # ステップ5: デプロイサマリーの表示
      - name: Deployment Summary
        run: |
          echo "## Application Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ Application: env-inspector" >> $GITHUB_STEP_SUMMARY
          
          if [ -n "${{ steps.deploy-webapp.outputs.webapp_url }}" ]; then
            echo "🌐 Web App URL: ${{ steps.deploy-webapp.outputs.webapp_url }}" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -n "${{ steps.deploy-functions.outputs.function_url }}" ]; then
            echo "⚡ Functions URL: ${{ steps.deploy-functions.outputs.function_url }}" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "🔗 [View Resource Group in Azure Portal](https://portal.azure.com/#@/resource/subscriptions/${{ secrets.AZURE_SUBSCRIPTION_ID }}/resourceGroups/${{ secrets.RESOURCE_GROUP_NAME }})" >> $GITHUB_STEP_SUMMARY
```

**技術詳細**:

1. **`npm ci` vs `npm install`**
   - `npm ci`: CI/CD環境向け、package-lock.jsonを厳密に使用
   - 高速、クリーンインストール
   - `npm install`: 開発環境向け、依存関係を更新可能

2. **`actions/upload-artifact@v4`**
   - ジョブ間でファイルを共有する仕組み
   - buildジョブでビルド成果物を保存
   - deployジョブでダウンロードして使用

3. **`if [ -n "${{ secrets.WEBAPP_NAME }}" ]`**
   - Secretsが設定されている場合のみデプロイ実行
   - Web AppとFunctionsの両方に対応
   - 柔軟なデプロイ先の選択

4. **ZIPデプロイ**
   - Azure App ServiceのZIPデプロイ機能を使用
   - シンプルで高速
   - ダウンタイムが少ない

**実行フロー**:
```
【buildジョブ】
1. ソースコードのチェックアウト
2. Node.js環境のセットアップ
3. 依存パッケージのインストール
4. テスト実行（あれば）
5. ビルド実行（あれば）
6. ZIPパッケージの作成
7. アーティファクトとしてアップロード

【deployジョブ】
1. アーティファクトのダウンロード
2. Azureに認証
3. Web Appまたは Functionsにデプロイ
4. デプロイ結果の表示
```

---

### 3. `SECRETS_SETUP.md`
**目的**: GitHub Secretsの設定ガイド

**主要な内容**:

1. **必須のSecrets**
   - `AZURE_CREDENTIALS`: Azureサービスプリンシパルの認証情報
   - `AZURE_SUBSCRIPTION_ID`: サブスクリプションID
   - `RESOURCE_GROUP_NAME`: リソースグループ名

2. **オプションのSecrets**
   - `WEBAPP_NAME`: Web App名
   - `FUNCTION_APP_NAME`: Function App名

3. **サービスプリンシパルの作成方法**
   ```bash
   az ad sp create-for-rbac \
     --name "github-actions-azure-env-inspector" \
     --role contributor \
     --scopes /subscriptions/<subscription-id> \
     --sdk-auth
   ```

4. **JSON形式の出力例**
   ```json
   {
     "clientId": "<client-id>",
     "clientSecret": "<client-secret>",
     "subscriptionId": "<subscription-id>",
     "tenantId": "<tenant-id>",
     ...
   }
   ```

5. **GitHub Secretsの設定手順**
   - GitHubリポジトリ → Settings → Secrets and variables → Actions
   - New repository secret
   - NameとValueを入力

---

## GitHub Actionsの実行方法

### 手動実行（現在の設定）

1. **GitHubリポジトリを開く**
   ```
   https://github.com/masatoshisato/azure-env-inspector
   ```

2. **Actionsタブをクリック**

3. **ワークフローを選択**
   - 左サイドバーから「Deploy Infrastructure」または「Deploy Application」

4. **`Run workflow`ボタンをクリック**

5. **パラメータを選択**
   - Branch: main
   - Environment: dev / staging / prod

6. **`Run workflow`ボタンをクリック（実行）**

7. **実行状況の確認**
   - リアルタイムでログを確認
   - 各ステップの成功/失敗を確認

---

### 自動実行（将来的に有効化する場合）

**設定方法**:

1. **ワークフローファイルを編集**
   ```yaml
   on:
     push:  # コメントを外す
       branches:
         - main
       paths:
         - 'infra/**'  # または 'apps/env-inspector/**'
     workflow_dispatch:
   ```

2. **コミット・プッシュ**
   ```bash
   git add .github/workflows/infra-deploy.yml
   git commit -m "Enable auto-deployment for infrastructure"
   git push origin main
   ```

3. **動作確認**
   - `infra/`配下を編集してプッシュ
   - GitHub Actionsが自動実行される

---

## トラブルシューティング

### エラー: `Azure Login failed`

**原因**: Secretsが未設定または不正

**解決方法**:
1. Secretsが設定されているか確認
2. サービスプリンシパルが有効か確認
   ```bash
   az login --service-principal \
     --username <client-id> \
     --password <client-secret> \
     --tenant <tenant-id>
   ```

---

### エラー: `Permission denied`

**原因**: サービスプリンシパルに適切なRBACロールがない

**解決方法**:
```bash
# Contributorロールを付与
az role assignment create \
  --assignee <client-id> \
  --role Contributor \
  --scope /subscriptions/<subscription-id>
```

---

### ワークフローが実行されない

**原因**: トリガー条件に一致しない

**解決方法**:
- 手動トリガーの場合: 「Run workflow」ボタンを押す
- 自動トリガーの場合: 
  - `paths`フィルターに一致するファイルを変更
  - ブランチが正しいか確認（mainブランチ）

---

### アーティファクトが見つからない

**原因**: buildジョブが失敗またはアーティファクト名の不一致

**解決方法**:
1. buildジョブのログを確認
2. アーティファクト名が一致しているか確認
   - upload: `name: app-package`
   - download: `name: app-package`

---

## まとめ

- **GitHub Actions**: CI/CDパイプラインの自動化
- **手動トリガー**: 現在は安全のため手動実行のみ
- **ジョブ依存関係**: 検証→デプロイの順序を保証
- **Secrets**: 認証情報を安全に管理
- **アーティファクト**: ジョブ間でビルド成果物を共有
- **自動化**: 将来的にはプッシュで自動デプロイ可能
