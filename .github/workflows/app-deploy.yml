name: Deploy Application

on:
  # è‡ªå‹•ãƒˆãƒªã‚¬ãƒ¼ï¼ˆSecretsè¨­å®šå¾Œã«æœ‰åŠ¹åŒ–ï¼‰
  # push:
  #   branches:
  #     - main
  #   paths:
  #     - 'apps/env-inspector/**'
  #     - '.github/workflows/app-deploy.yml'
  
  # æ‰‹å‹•ãƒˆãƒªã‚¬ãƒ¼
  workflow_dispatch:
    inputs:
      app_name:
        description: 'Application to deploy'
        required: true
        default: 'env-inspector'
        type: choice
        options:
          - env-inspector

jobs:
  build:
    name: Build Application
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'apps/env-inspector/package-lock.json'

      - name: Install dependencies
        working-directory: apps/env-inspector
        run: npm ci

      - name: Run tests
        working-directory: apps/env-inspector
        run: npm test --if-present

      - name: Build application
        working-directory: apps/env-inspector
        run: npm run build --if-present

      - name: Create deployment package
        working-directory: apps/env-inspector
        run: |
          # ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ZIPã«ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸åŒ–
          zip -r ../env-inspector.zip . -x "node_modules/*" "*.git*"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-package
          path: apps/env-inspector.zip
          retention-days: 1

  deploy:
    name: Deploy to Azure
    runs-on: ubuntu-latest
    needs: build
    # æœ¬ç•ªç’°å¢ƒã¸ã®è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’é˜²ãå ´åˆã¯ã€ä»¥ä¸‹ã‚’ã‚³ãƒ¡ãƒ³ãƒˆè§£é™¤
    # environment: 
    #   name: production
    
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: app-package

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # Web Appã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤ä¾‹
      - name: Deploy to Azure Web App
        id: deploy-webapp
        run: |
          # Web AppãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ãƒ‡ãƒ—ãƒ­ã‚¤
          # ãƒªã‚½ãƒ¼ã‚¹åã¯ç’°å¢ƒå¤‰æ•°ã¾ãŸã¯Secretsã§ç®¡ç†
          if [ -n "${{ secrets.WEBAPP_NAME }}" ]; then
            az webapp deployment source config-zip \
              --resource-group ${{ secrets.RESOURCE_GROUP_NAME }} \
              --name ${{ secrets.WEBAPP_NAME }} \
              --src env-inspector.zip
            
            WEBAPP_URL=$(az webapp show \
              --resource-group ${{ secrets.RESOURCE_GROUP_NAME }} \
              --name ${{ secrets.WEBAPP_NAME }} \
              --query defaultHostName -o tsv)
            echo "webapp_url=https://$WEBAPP_URL" >> $GITHUB_OUTPUT
          fi

      # Azure Functionsã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤ä¾‹
      - name: Deploy to Azure Functions
        id: deploy-functions
        run: |
          # Azure FunctionsãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ãƒ‡ãƒ—ãƒ­ã‚¤
          if [ -n "${{ secrets.FUNCTION_APP_NAME }}" ]; then
            az functionapp deployment source config-zip \
              --resource-group ${{ secrets.RESOURCE_GROUP_NAME }} \
              --name ${{ secrets.FUNCTION_APP_NAME }} \
              --src env-inspector.zip
            
            FUNC_URL=$(az functionapp show \
              --resource-group ${{ secrets.RESOURCE_GROUP_NAME }} \
              --name ${{ secrets.FUNCTION_APP_NAME }} \
              --query defaultHostName -o tsv)
            echo "function_url=https://$FUNC_URL" >> $GITHUB_OUTPUT
          fi

      - name: Deployment Summary
        run: |
          echo "## Application Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Application: env-inspector" >> $GITHUB_STEP_SUMMARY
          
          if [ -n "${{ steps.deploy-webapp.outputs.webapp_url }}" ]; then
            echo "ðŸŒ Web App URL: ${{ steps.deploy-webapp.outputs.webapp_url }}" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -n "${{ steps.deploy-functions.outputs.function_url }}" ]; then
            echo "âš¡ Functions URL: ${{ steps.deploy-functions.outputs.function_url }}" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— [View Resource Group in Azure Portal](https://portal.azure.com/#@/resource/subscriptions/${{ secrets.AZURE_SUBSCRIPTION_ID }}/resourceGroups/${{ secrets.RESOURCE_GROUP_NAME }})" >> $GITHUB_STEP_SUMMARY
