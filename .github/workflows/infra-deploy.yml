name: Deploy Infrastructure

on:
  # è‡ªå‹•ãƒˆãƒªã‚¬ãƒ¼ï¼ˆSecretsè¨­å®šå¾Œã«æœ‰åŠ¹åŒ–ï¼‰
  # push:
  #   branches:
  #     - main
  #   paths:
  #     - 'infra/**'
  #     - '.github/workflows/infra-deploy.yml'
  
  # æ‰‹å‹•ãƒˆãƒªã‚¬ãƒ¼
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - prod

env:
  AZURE_LOCATION: japaneast

jobs:
  validate:
    name: Validate Bicep Templates
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Install Bicep CLI
        run: az bicep install

      - name: Bicep Build (Lint)
        run: |
          echo "Building Bicep templates to check for errors..."
          az bicep build --file infra/main.bicep

      - name: What-If Analysis
        run: |
          echo "Running what-if analysis to preview changes..."
          az deployment sub what-if \
            --name "infra-whatif-$(date +%Y%m%d-%H%M%S)" \
            --location ${{ env.AZURE_LOCATION }} \
            --template-file infra/main.bicep \
            --parameters infra/main.parameters.bicepparam

  deploy:
    name: Deploy to Azure
    runs-on: ubuntu-latest
    needs: validate
    # æœ¬ç•ªç’°å¢ƒã¸ã®è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’é˜²ãå ´åˆã¯ã€ä»¥ä¸‹ã‚’ã‚³ãƒ¡ãƒ³ãƒˆè§£é™¤
    # environment: 
    #   name: production
    #   url: https://portal.azure.com
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy Infrastructure
        id: deploy
        run: |
          DEPLOYMENT_NAME="infra-deploy-$(date +%Y%m%d-%H%M%S)"
          echo "deployment_name=$DEPLOYMENT_NAME" >> $GITHUB_OUTPUT
          
          az deployment sub create \
            --name "$DEPLOYMENT_NAME" \
            --location ${{ env.AZURE_LOCATION }} \
            --template-file infra/main.bicep \
            --parameters infra/main.parameters.bicepparam

      - name: Get Deployment Outputs
        run: |
          echo "Deployment completed. Fetching outputs..."
          az deployment sub show \
            --name "${{ steps.deploy.outputs.deployment_name }}" \
            --query properties.outputs

      - name: Deployment Summary
        run: |
          echo "## Infrastructure Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Deployment Name: ${{ steps.deploy.outputs.deployment_name }}" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŒ Location: ${{ env.AZURE_LOCATION }}" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— [View in Azure Portal](https://portal.azure.com/#blade/HubsExtension/DeploymentDetailsBlade/overview)" >> $GITHUB_STEP_SUMMARY
